import type { ScanRule } from "../types.js";

/**
 * Malware/staged-delivery patterns.
 * These are focused on execution-boundary signals (download-and-exec, decode-and-exec, bypass commands).
 */
export function getMalwareRules(): ScanRule[] {
  return [
    {
      id: "malware-staged-delivery",
      category: "malware",
      enabled: true,
      action: "shutdown",
      patterns: [
        // curl/wget piped to shell
        /\b(?:curl|wget)\b[\s\S]{0,220}?\|\s*(?:sh|bash|zsh)\b/gi,
        // fetch and execute in one line without explicit pipe
        /\b(?:curl|wget)\b[\s\S]{0,220}?\b(?:chmod\s+\+x|sh|bash|zsh)\b/gi,
        // PowerShell download-and-exec
        /\bpowershell(?:\.exe)?\b[\s\S]{0,240}?\b(?:Invoke-WebRequest|iwr|DownloadString)\b[\s\S]{0,120}?\b(?:iex|Invoke-Expression)\b/gi,
      ],
      keywords: [],
    },
    {
      id: "malware-encoded-exec",
      category: "malware",
      enabled: true,
      action: "shutdown",
      patterns: [
        // base64 decode piped to shell
        /\b(?:echo|printf)\b[\s\S]{0,220}?\bbase64\b[\s\S]{0,80}?(?:-d|--decode)\b[\s\S]{0,100}?\|\s*(?:sh|bash|zsh)\b/gi,
        // Python decode + exec
        /\bpython(?:3)?\b[\s\S]{0,220}?\b(?:base64|b64decode)\b[\s\S]{0,120}?\bexec\s*\(/gi,
      ],
      keywords: [],
    },
    {
      id: "malware-quarantine-bypass",
      category: "malware",
      enabled: true,
      action: "block",
      patterns: [
        /\brm\s+-rf\s+.*(?:quarantine|isolat(?:e|ion)|containment)/gi,
        /\b(?:mv|cp)\b[\s\S]{0,120}?(?:quarantine|isolat(?:e|ion))[\s\S]{0,120}?\b(?:extensions|plugins?)\b/gi,
      ],
      keywords: [
        "disable quarantine",
        "bypass quarantine",
      ],
    },
  ];
}
