import type { ScanRule } from "../types.js";

/**
 * Malware detection rules for staged delivery attacks.
 *
 * These patterns detect:
 * 1. Staged delivery (curl|sh, wget|bash, base64|sh)
 * 2. Obfuscated payload execution
 * 3. Quarantine bypass attempts
 * 4. Suspicious shell spawning
 */

/** Malware detection patterns */
export const MALWARE_PATTERNS: Record<string, RegExp[]> = {
  "staged-delivery": [
    // curl/wget piped to shell
    /\b(?:curl|wget)\s+(?:-[a-zA-Z]*\s+)*["']?https?:\/\/[^\s"']+["']?\s*\|\s*(?:bash|sh|zsh|ksh|dash|csh|tcsh|fish)/gi,
    // Reversed order: shell with process substitution
    /\b(?:bash|sh|zsh)\s+(?:-[a-zA-Z]*\s+)*<\s*\(\s*(?:curl|wget)\s+/gi,
    // Source with curl
    /\bsource\s+<\s*\(\s*(?:curl|wget)\s+/gi,
    // eval with curl/wget
    /\beval\s+["']?\$\(\s*(?:curl|wget)\s+/gi,
  ],
  "base64-execution": [
    // base64 decoded and piped to shell
    /\bbase64\s+(?:-[dD]|--decode)\s*.*\|\s*(?:bash|sh|zsh|eval)/gi,
    // echo base64 | decode | shell
    /\becho\s+["']?[A-Za-z0-9+\/=]{20,}["']?\s*\|\s*base64\s+(?:-[dD]|--decode)\s*\|\s*(?:bash|sh)/gi,
    // Python/Node base64 decode execution
    /\bpython[23]?\s+-c\s+["']import\s+base64.*exec/gi,
    /\bnode\s+-e\s+["'].*(?:Buffer\.from|atob).*eval/gi,
  ],
  "obfuscated-execution": [
    // Hex-escaped command execution
    /\$["']\\x[0-9a-fA-F]{2}(?:\\x[0-9a-fA-F]{2})+["']/g,
    // Octal-escaped commands
    /\$["']\\[0-7]{3}(?:\\[0-7]{3})+["']/g,
    // Unicode escape sequences in shell
    /\$["']\$["']\\u[0-9a-fA-F]{4}/g,
    // printf with escaped shell command execution
    /\bprintf\s+["'][^"']*\\x[0-9a-fA-F].*\|\s*(?:bash|sh)/gi,
  ],
  "quarantine-bypass": [
    // Attempts to remove quarantine attributes (macOS)
    /\bxattr\s+(?:-[cdrw]+\s+)*-d\s+com\.apple\.quarantine/gi,
    /\bxattr\s+(?:-[cdrw]+\s+)*-c\s+/gi,
    // Windows zone identifier removal
    /\bRemove-Item\s+.*:Zone\.Identifier/gi,
    /\bads\s+-d\s+/gi,
    // Disable Gatekeeper (macOS)
    /\bspctl\s+--master-disable/gi,
    // Modify security preferences
    /\bdefaults\s+write\s+.*LSQuarantine/gi,
  ],
  "suspicious-download": [
    // Download to /tmp with execution (curl/wget ... /tmp/... && chmod/bash/sh)
    /\b(?:curl|wget)\s+[^|]*\/tmp\/\S+[^|]*&&\s*(?:chmod|bash|sh|\.\/)/gi,
    // Download to hidden file
    /\b(?:curl|wget)\s+(?:-[a-zA-Z]*\s+)*(?:--output|-o)\s+[^\s]*\/\.[^\s]+/gi,
    // PowerShell download cradle (IEX with DownloadString)
    /\bInvoke-(?:WebRequest|RestMethod)\s.*-OutFile.*Start-Process/gi,
    /\bIEX\s*\(?(?:\s*\()?\s*New-Object\s+Net\.WebClient\)\.DownloadString/gi,
    // Certutil download (Windows LOLBin)
    /\bcertutil(?:\.exe)?\s+(?:-urlcache|-split).*-f\s+https?:\/\//gi,
  ],
  "reverse-shell": [
    // Bash reverse shell - /dev/tcp pattern
    /\bbash\s+-[ic]+\s+["']?bash\s+-i\s+>&?\s*\/dev\/tcp/gi,
    /\/dev\/tcp\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\/\d+/gi,
    // Bash -c with exec and /dev/tcp
    /\bbash\s+-c\s+["'](?:0<&\d+|exec\s+\d+<>).*\/dev\/tcp/gi,
    // Netcat reverse shell (nc with -e flag)
    /\b(?:nc|netcat|ncat)\s+(?:-[a-zA-Z]*\s+)*(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|[\w.-]+)\s+\d+\s*-e\s*(?:\/bin\/(?:ba)?sh|cmd|sh)/gi,
    // Netcat reverse shell (order: nc -e /bin/sh host port)
    /\b(?:nc|netcat|ncat)\s+-e\s+(?:\/bin\/(?:ba)?sh|cmd|sh)\s+(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|[\w.-]+)\s+\d+/gi,
    // Python reverse shell
    /\bpython[23]?\s+-c\s+["']import\s+socket.*(?:subprocess|os\.dup2|pty\.spawn)/gi,
    // Ruby/Perl reverse shells
    /\bruby\s+-rsocket\s+-e\s*["'].*TCPSocket/gi,
    /\bperl\s+-e\s+["']use\s+Socket.*exec/gi,
  ],
  "persistence-mechanism": [
    // Crontab manipulation
    /\bcrontab\s+(?:-[lreu]\s+)*["']?.*(?:curl|wget|\/tmp\/|bash\s+-c)/gi,
    /\becho\s+.*>>\s*\/(?:etc\/cron|var\/spool\/cron)/gi,
    // Systemd service creation
    /\bsystemctl\s+(?:enable|start)\s+.*\.service.*curl/gi,
    // LaunchAgent/LaunchDaemon (macOS)
    /\b(?:launchctl\s+load|cp\s+.*\.plist\s+.*LaunchAgents)/gi,
    // Windows scheduled tasks
    /\bschtasks\s+\/create\s+.*\/tr\s+["']?(?:powershell|cmd|wscript)/gi,
    // Registry run keys (Windows)
    /\breg\s+add\s+.*\\(?:Run|RunOnce)\s+/gi,
  ],
};

/** Get malware detection rules */
export function getMalwareRules(): ScanRule[] {
  return [
    {
      id: "malware-staged-delivery",
      category: "malware",
      enabled: true,
      action: "shutdown",
      patterns: MALWARE_PATTERNS["staged-delivery"],
    },
    {
      id: "malware-base64-execution",
      category: "malware",
      enabled: true,
      action: "shutdown",
      patterns: MALWARE_PATTERNS["base64-execution"],
    },
    {
      id: "malware-obfuscated-execution",
      category: "malware",
      enabled: true,
      action: "shutdown",
      patterns: MALWARE_PATTERNS["obfuscated-execution"],
    },
    {
      id: "malware-quarantine-bypass",
      category: "malware",
      enabled: true,
      action: "shutdown",
      patterns: MALWARE_PATTERNS["quarantine-bypass"],
    },
    {
      id: "malware-suspicious-download",
      category: "malware",
      enabled: true,
      action: "block",
      patterns: MALWARE_PATTERNS["suspicious-download"],
    },
    {
      id: "malware-reverse-shell",
      category: "malware",
      enabled: true,
      action: "shutdown",
      patterns: MALWARE_PATTERNS["reverse-shell"],
    },
    {
      id: "malware-persistence",
      category: "malware",
      enabled: true,
      action: "block",
      patterns: MALWARE_PATTERNS["persistence-mechanism"],
    },
  ];
}
